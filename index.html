ctx.moveTo(resultPoints[0].getX(), resultPoints[0].getY());
                            for (let i = 1; i < resultPoints.length; i++) {
                                ctx.lineTo(resultPoints[i].getX(), resultPoints[i].getY());
                            }
                            ctx.closePath();
                            ctx.stroke();
                            
                            // ISBNの形式を確認（数字とハイフンのみ）
                            if (/^[0-9\-]+$/.test(rawIsbn)) {
                                // ハイフンを除去
                                const isbn = rawIsbn.replace(/-/g, '');
                                
                                // 10桁または13桁のISBNかチェック
                                if (isbn.length === 10 || isbn.length === 13) {
                                    // 成功通知を表示
                                    showNotification('バーコードを読み取りました: ' + isbn);
                                    
                                    // スキャナーを一時停止
                                    clearScanTimeout();
                                    setTimeout(() => {
                                        codeReader.reset();
                                        
                                        // 検索フォームに入力して検索
                                        isbnInput.value = isbn;
                                        searchBook();
                                        
                                        // 手動入力に戻す
                                        setTimeout(() => {
                                            canvas.remove();
                                            manualOption.click();
                                        }, 500);
                                    }, 1000);
                                } else {
                                    // ISBNの桁数が不正
                                    showError('有効なISBNではありません。10桁または13桁のISBNを読み取ってください。');
                                    setTimeout(() => canvas.remove(), 1000);
                                }
                            } else {
                                // ISBNの形式が不正
                                showError('バーコードからISBNを検出できませんでした。');
                                setTimeout(() => canvas.remove(), 1000);
                            }
                        }
                    }, hints).catch(err => {
                        console.error('デコード開始エラー:', err);
                        showError('カメラからのデコードを開始できませんでした');
                        scannerVideo.style.filter = '';
                        const loadingSpinner = scannerContainer.querySelector('.loading-spinner');
                        if (loadingSpinner) {
                            loadingSpinner.remove();
                        }
                    });
                    
                    // スキャンタイムアウト設定
                    startScanTimeout();
                } catch (error) {
                    console.error('startScannerエラー:', error);
                    showError('スキャナーの起動に失敗しました: ' + error.message);
                }
            }

            // ISBNから書籍情報を検索する関数
            function searchBook() {
                const isbn = isbnInput.value.trim().replace(/-/g, '');
                
                if (!isbn) {
                    showError('ISBNを入力してください');
                    return;
                }

                if (!/^\d{10}(\d{3})?$/.test(isbn)) {
                    showError('ISBNは10桁または13桁の数字で入力してください');
                    return;
                }

                // エラーメッセージをクリア
                hideError();
                
                // ローディング表示
                loadingElement.style.display = 'block';
                
                // 編集モードをリセット
                resetEditMode();

                // モックAPIが有効かチェック
                const useMockApi = useMockApiCheckbox.checked;

                // オフラインまたはモックAPI使用時はローカルデータを検索
                if (!navigator.onLine || useMockApi) {
                    // 既存の記録を検索
                    const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const existingRecord = records.find(record => record.isbn === isbn);
                    
                    if (existingRecord) {
                        displayBookInfo(existingRecord);
                        loadingElement.style.display = 'none';
                        return;
                    } else if (useMockApi) {
                        // モックデータを生成
                        const mockBookData = generateMockBookData(isbn);
                        displayBookInfo(mockBookData);
                        loadingElement.style.display = 'none';
                        return;
                    } else {
                        loadingElement.style.display = 'none';
                        showError('オフラインモードでは新しい書籍を検索できません');
                        return;
                    }
                }

                // APIリトライカウンターをリセット
                apiRetryCount = 0;
                
                // 書籍情報を取得
                fetchBookInfo(isbn);
            }
            
            // 書籍情報をAPIから取得する関数
            function fetchBookInfo(isbn) {
                // サーバーAPIを使用して書籍情報を取得
                fetch(`/api/books?isbn=${isbn}`)
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 429) {
                                // レート制限エラーの場合
                                throw new Error('APIのリクエスト制限に達しました。しばらく待ってから再試行してください。');
                            }
                            throw new Error('ネットワークエラーが発生しました');
                        }
                        return response.json();
                    })
                    .then(bookInfo => {
                        // ローディング非表示
                        loadingElement.style.display = 'none';
                        
                        // 評価をリセット
                        setRating(0);
                        
                        // タグをリセット
                        currentTags = [];
                        updateTagsDisplay();
                        
                        // UI更新
                        displayBookInfo(bookInfo);
                    })
                    .catch(error => {
                        console.error('Error fetching book data:', error);
                        
                        // レート制限エラーの場合、一定時間後に再試行
                        if (error.message.includes('リクエスト制限') && apiRetryCount < MAX_API_RETRIES) {
                            apiRetryCount++;
                            const retryDelay = 2000 * apiRetryCount; // 徐々に待ち時間を増やす
                            
                            showError(`APIのリクエスト制限に達しました。${retryDelay/1000}秒後に再試行します...`);
                            
                            setTimeout(() => {
                                fetchBookInfo(isbn);
                            }, retryDelay);
                            
                            return;
                        }
                        
                        // ローディング非表示
                        loadingElement.style.display = 'none';
                        showError(error.message);
                        bookContainer.style.display = 'none';
                        
                        // ローカルに保存されている書籍を検索
                        const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                        const existingRecord = records.find(record => record.isbn === isbn);
                        
                        if (existingRecord) {
                            showError('オンラインでの検索に失敗しましたが、ローカルに保存されたデータを表示します。');
                            displayBookInfo(existingRecord);
                        } else if (useMockApiCheckbox.checked) {
                            // モックデータを生成
                            showError('オンラインでの検索に失敗しましたが、モックデータを生成します。');
                            const mockBookData = generateMockBookData(isbn);
                            displayBookInfo(mockBookData);
                        }
                    });
            }
            
            // モック書籍データを生成する関数
            function generateMockBookData(isbn) {
                // 13桁のISBNからカテゴリを特定（最初の3桁）
                let category = '';
                let publisher = '';
                
                if (isbn.length === 13) {
                    const prefix = isbn.substring(3, 7);
                    
                    // 出版社のコードからジャンルを推測
                    if (prefix >= '0000' && prefix <= '2499') {
                        category = '文学・小説';
                        publisher = 'サンプル出版社';
                    } else if (prefix >= '2500' && prefix <= '3999') {
                        category = 'コミック・漫画';
                        publisher = 'マンガアート社';
                    } else if (prefix >= '4000' && prefix <= '6999') {
                        category = '実用書・ビジネス';
                        publisher = 'ビジネス出版';
                    } else if (prefix >= '7000' && prefix <= '8499') {
                        category = '科学・技術書';
                        publisher = 'テクノブックス';
                    } else {
                        category = '一般書籍';
                        publisher = '総合出版';
                    }
                } else {
                    // ISBN-10の場合
                    const prefix = isbn.substring(0, 2);
                    if (prefix >= '00' && prefix <= '19') {
                        category = '文学・小説';
                        publisher = '文学社';
                    } else if (prefix >= '20' && prefix <= '39') {
                        category = 'コミック・漫画';
                        publisher = 'コミックハウス';
                    } else if (prefix >= '40' && prefix <= '69') {
                        category = '実用書・ビジネス';
                        publisher = 'ビジネスプレス';
                    } else if (prefix >= '70' && prefix <= '84') {
                        category = '科学・技術書';
                        publisher = 'サイエンス出版';
                    } else {
                        category = '一般書籍';
                        publisher = '一般書籍出版';
                    }
                }
                
                // タイトルを生成
                let title = `サンプル書籍（ISBN: ${isbn}）`;
                
                // シリーズ物の場合
                if (Math.random() > 0.7) {
                    const volume = Math.floor(Math.random() * 20) + 1;
                    title = `サンプルシリーズ ${volume}巻`;
                }
                
                // 著者名を生成
                const authorSurnames = ['佐藤', '鈴木', '高橋', '田中', '伊藤', '渡辺', '山本', '中村', '小林', '加藤'];
                const authorNames = ['太郎', '次郎', '花子', '裕子', '健太', '翔太', '優子', '直樹', '洋介', '恵子'];
                const author = `${authorSurnames[Math.floor(Math.random() * authorSurnames.length)]} ${authorNames[Math.floor(Math.random() * authorNames.length)]}`;
                
                // 出版日を生成（過去10年以内）
                const currentYear = new Date().getFullYear();
                const year = currentYear - Math.floor(Math.random() * 10);
                const month = Math.floor(Math.random() * 12) + 1;
                const day = Math.floor(Math.random() * 28) + 1;
                const publishedDate = `${year}年${month}月${day}日`;
                
                // カバー画像を生成
                const coverSrc = `https://via.placeholder.com/140x200/4488cc/ffffff?text=${encodeURIComponent(title)}`;
                
                return {
                    title,
                    author,
                    publisher,
                    publishedDate,
                    isbn,
                    coverSrc,
                    category
                };
            }
            
            // 書籍情報を表示する関数
            function displayBookInfo(bookInfo) {
                // タイトルから巻数を抽出
                const { title, volumeNumber } = extractVolumeNumber(bookInfo.title);
                bookTitle.textContent = title + (volumeNumber ? ` (${volumeNumber})` : '');
                
                // 著者、出版社、出版日をリンクとして設定
                bookAuthor.innerHTML = '著者: <a href="#" class="book-link" data-type="author" data-value="' + 
                    bookInfo.author + '">' + bookInfo.author + '</a>';
                bookPublisher.innerHTML = '出版社: <a href="#" class="book-link" data-type="publisher" data-value="' + 
                    bookInfo.publisher + '">' + bookInfo.publisher + '</a>';
                bookPublishedDate.textContent = '出版日: ' + bookInfo.publishedDate;
                bookIsbn.textContent = 'ISBN: ' + bookInfo.isbn;
                
                // 書影がある場合は表示、なければプレースホルダー
                if (bookInfo.coverSrc) {
                    bookCoverImg.src = bookInfo.coverSrc;
                } else {
                    bookCoverImg.src = 'icons/placeholder.svg';
                }
                
                // 書籍情報コンテナを表示
                bookContainer.style.display = 'block';
                
                // 入力欄をクリア
                readingNotes.value = bookInfo.notes || '';
                
                // 読書状況を設定
                const status = bookInfo.status || 'unread';
                readingStatusSelect.value = status;
                
                // 読書状況ボタンを更新
                statusButtons.forEach(button => {
                    if (button.getAttribute('data-status') === status) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
                
                // 読了日を設定
                if (bookInfo.completionDate) {
                    completionDateInput.value = bookInfo.completionDate;
                    if (status === 'finished') {
                        completionDateContainer.classList.add('show');
                    }
                } else {
                    completionDateInput.value = '';
                    if (status === 'finished') {
                        completionDateContainer.classList.add('show');
                        const today = new Date().toISOString().split('T')[0];
                        completionDateInput.value = today;
                    } else {
                        completionDateContainer.classList.remove('show');
                    }
                }
                
                // 評価を設定
                if (bookInfo.rating) {
                    setRating(bookInfo.rating);
                } else {
                    setRating(0);
                }
                
                // タグを設定
                if (bookInfo.tags && Array.isArray(bookInfo.tags)) {
                    currentTags = [...bookInfo.tags];
                } else {
                    currentTags = [];
                }
                updateTagsDisplay();

                // 書籍情報にスクロール
                bookContainer.scrollIntoView({ behavior: 'smooth' });
                
                // リンクのクリックイベントを設定
                setupBookLinks();
                
                // 戻るボタンを表示
                backButton.style.display = 'block';
                
                // 既存の記録の場合は削除ボタンを表示
                if (bookInfo.id) {
                    currentRecordId = bookInfo.id;
                    deleteBookButton.style.display = 'block';
                }
            }
            
            // 書籍リンクのクリックイベントを設定
            function setupBookLinks() {
                const bookLinks = document.querySelectorAll('.book-link');
                bookLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const type = this.getAttribute('data-type');
                        const value = this.getAttribute('data-value');
                        
                        // フィルターを適用
                        filterByAttribute(type, value);
                    });
                });
            }
            
            // 属性でフィルタリングする関数
            function filterByAttribute(type, value) {
                let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                let filteredRecords = [];
                
                switch(type) {
                    case 'title':
                        // タイトルの基本部分で一致するものを検索（巻数を除く）
                        const baseTitle = extractVolumeNumber(value).title;
                        filteredRecords = records.filter(record => {
                            const recordBaseTitle = extractVolumeNumber(record.title).title;
                            return recordBaseTitle === baseTitle;
                        });
                        break;
                    case 'author':
                        filteredRecords = records.filter(record => record.author === value);
                        break;
                    case 'publisher':
                        filteredRecords = records.filter(record => record.publisher === value);
                        break;
                }
                
                // 結果を表示
                displayFilteredRecords(filteredRecords, type, value);
            }
            
            // フィルタリング結果を表示
            function displayFilteredRecords(records, type, value) {
                // 書籍情報コンテナを非表示
                bookContainer.style.display = 'none';
                
                // リストをクリア
                bookListContainer.innerHTML = '';
                
                if (records.length === 0) {
                    bookListContainer.innerHTML = `<p>「${value}」に一致する読書記録はありません</p>`;
                    return;
                }
                
                // フィルタリング情報を表示
                const typeLabels = {
                    'title': 'タイトル',
                    'author': '著者',
                    'publisher': '出版社'
                };
                
                bookListContainer.innerHTML = `<p>「${typeLabels[type]}: ${value}」で絞り込み中 (${records.length}件)</p>`;
                
                // 読書記録を表示
                records.forEach(record => {
                    displayRecordItem(record);
                });
            }
            
            // タイトルから巻数を抽出する関数
            function extractVolumeNumber(title) {
                if (!title) return { title: '', volumeNumber: null };
                
                // 巻数のパターン: 第X巻、X巻、(X)、Vol.X、#X など
                const volumePatterns = [
                    /第(\d+)巻/,
                    /(\d+)巻/,
                    /\((\d+)\)/,
                    /Vol\.(\d+)/,
                    /#(\d+)/,
                    /（(\d+)）/,
                    /\s(\d+)$/
                ];
                
                let volumeNumber = null;
                let cleanTitle = title;
                
                for (const pattern of volumePatterns) {
                    const match = title.match(pattern);
                    if (match) {
                        volumeNumber = match[1];
                        cleanTitle = title.replace(match[0], '').trim();
                        break;
                    }
                }
                
                return { title: cleanTitle, volumeNumber };
            }
            
            // 評価（星）を設定する関数
            function setRating(rating) {
                currentRating = rating;
                highlightStars(rating);
            }
            
            // 星を強調表示する関数
            function highlightStars(rating) {
                const stars = ratingStars.querySelectorAll('i');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
            
            // タグを追加する関数
            function addTag(tagName) {
                // 重複チェック
                if (!currentTags.includes(tagName)) {
                    currentTags.push(tagName);
                    updateTagsDisplay();
                    
                    // 全タグリストに追加
                    if (!allTags.includes(tagName)) {
                        allTags.push(tagName);
                        saveTags();
                        updateTagFilters();
                    }
                }
            }
            
            // タグ表示を更新する関数
            function updateTagsDisplay() {
                // 現在のタグ要素を削除（入力フィールド以外）
                const elements = tagsInputContainer.querySelectorAll('.tag');
                elements.forEach(el => el.remove());
                
                // タグを追加
                currentTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `${tag} <span class="remove-tag">&times;</span>`;
                    
                    // タグ削除イベント
                    tagElement.querySelector('.remove-tag').addEventListener('click', () => {
                        currentTags = currentTags.filter(t => t !== tag);
                        updateTagsDisplay();
                    });
                    
                    // 入力フィールドの前に挿入
                    tagsInputContainer.insertBefore(tagElement, tagInput);
                });
            }
            
            // タグ候補を表示する関数
            function showTagSuggestions(query) {
                // 入力に一致するタグをフィルタリング
                const filteredTags = allTags.filter(tag => 
                    tag.toLowerCase().includes(query.toLowerCase()) && 
                    !currentTags.includes(tag)
                );
                
                if (filteredTags.length === 0) {
                    tagSuggestions.style.display = 'none';
                    return;
                }
                
                // 候補リストをクリア
                tagSuggestions.innerHTML = '';
                
                // 候補を追加
                filteredTags.forEach(tag => {
                    const suggestionElement = document.createElement('div');
                    suggestionElement.className = 'tag-suggestion';
                    suggestionElement.textContent = tag;
                    
                    // クリックイベント
                    suggestionElement.addEventListener('click', () => {
                        addTag(tag);
                        tagInput.value = '';
                        tagSuggestions.style.display = 'none';
                    });
                    
                    tagSuggestions.appendChild(suggestionElement);
                });
                
                // 候補リストを表示
                tagSuggestions.style.display = 'block';
            }
            
            // タグを保存する関数
            function saveTags() {
                localStorage.setItem(TAGS_KEY, JSON.stringify(allTags));
            }
            
            // タグを読み込む関数
            function loadTags() {
                const savedTags = localStorage.getItem(TAGS_KEY);
                if (savedTags) {
                    allTags = JSON.parse(savedTags);
                    updateTagFilters();
                }
            }
            
            // タグフィルターを更新する関数
            function updateTagFilters() {
                filterTags.innerHTML = '';
                
                if (allTags.length === 0) {
                    return;
                }
                
                // すべてのタグをフィルターとして追加
                allTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'filter-tag';
                    if (activeTagFilters.includes(tag)) {
                        tagElement.classList.add('active');
                    }
                    tagElement.textContent = tag;
                    
                    // クリックイベント
                    tagElement.addEventListener('click', () => {
                        if (activeTagFilters.includes(tag)) {
                            // フィルターを解除
                            activeTagFilters = activeTagFilters.filter(t => t !== tag);
                            tagElement.classList.remove('active');
                        } else {
                            // フィルターを追加
                            activeTagFilters.push(tag);
                            tagElement.classList.add('active');
                        }
                        applyFiltersAndSort();
                    });
                    
                    filterTags.appendChild(tagElement);
                });
            }

            // 読書記録に追加する関数
            function addBookToRecords() {
                const title = bookTitle.textContent;
                const author = bookAuthor.textContent.replace('著者: ', '');
                const publisher = bookPublisher.textContent.replace('出版社: ', '');
                const publishedDate = bookPublishedDate.textContent.replace('出版日: ', '');
                const isbn = bookIsbn.textContent.replace('ISBN: ', '');
                const coverSrc = bookCoverImg.src;
                const status = readingStatusSelect.value;
                const notes = readingNotes.value;
                const rating = currentRating;
                const tags = [...currentTags];
                const addedDate = new Date().toISOString();
                
                // 読了日を取得
                let completionDate = null;
                if (status === 'finished' && completionDateInput.value) {
                    completionDate = completionDateInput.value;
                }

                // 既存の読書記録を取得
                let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                if (currentRecordId) {
                    // 既存の記録を更新
                    const index = records.findIndex(record => record.id === currentRecordId);
                    
                    if (index !== -1) {
                        records[index].status = status;
                        records[index].notes = notes;
                        records[index].rating = rating;
                        records[index].tags = tags;
                        records[index].lastUpdated = addedDate;
                        records[index].completionDate = completionDate;
                        
                        // ローカルストレージに保存
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                        
                        // 読書記録を再表示
                        loadReadingRecords();
                        
                        // 書籍情報コンテナを非表示
                        bookContainer.style.display = 'none';
                        
                        // 編集モードをリセット
                        resetEditMode();
                        
                        showNotification('読書記録を更新しました', 'success');
                    }
                } else {
                    // 既存のISBNがあるか確認
                    const existingIndex = records.findIndex(record => record.isbn === isbn);
                    
                    if (existingIndex !== -1) {
                        // 確認なしで更新
                        records[existingIndex].status = status;
                        records[existingIndex].notes = notes;
                        records[existingIndex].rating = rating;
                        records[existingIndex].tags = tags;
                        records[existingIndex].lastUpdated = addedDate;
                        records[existingIndex].completionDate = completionDate;
                    } else {
                        // 読書記録オブジェクトを作成
                        const record = {
                            id: Date.now().toString(),
                            title,
                            author,
                            publisher,
                            publishedDate,
                            isbn,
                            coverSrc,
                            status,
                            notes,
                            rating,
                            tags,
                            addedDate,
                            lastUpdated: addedDate,
                            completionDate
                        };
                        
                        // 新しい記録を追加
                        records.push(record);
                    }
                    
                    // ローカルストレージに保存
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                    
                    // 読書記録を再表示
                    loadReadingRecords();
                    
                    // 書籍情報コンテナを非表示
                    bookContainer.style.display = 'none';
                    
                    // 入力欄をクリア
                    isbnInput.value = '';
                    
                    showNotification('読書記録に追加しました', 'success');
                }
            }

            // 保存された読書記録を読み込んで表示する関数
            function loadReadingRecords() {
                const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                // リストをクリア
                bookListContainer.innerHTML = '';
                
                if (records.length === 0) {
                    bookListContainer.innerHTML = '<p>読書記録はまだありません</p>';
                    return;
                }
                
                // フィルターと並び替えを適用
                applyFiltersAndSort();
            }
            
            // フィルターと並び替えを適用する関数
            function applyFiltersAndSort() {
                let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                // ステータスでフィルタリング
                const statusFilter = filterStatus.value;
                if (statusFilter !== 'all') {
                    records = records.filter(record => record.status === statusFilter);
                }
                
                // 評価でフィルタリング
                const ratingFilter = parseInt(filterRating.value);
                if (ratingFilter > 0) {
                    records = records.filter(record => (record.rating || 0) >= ratingFilter);
                } else if (ratingFilter === 0) {
                    records = records.filter(record => !record.rating || record.rating === 0);
                }
                
                // タグでフィルタリング
                if (activeTagFilters.length > 0) {
                    records = records.filter(record => {
                        if (!record.tags || !Array.isArray(record.tags)) return false;
                        return activeTagFilters.every(tag => record.tags.includes(tag));
                    });
                }
                
                // 並び替え
                const sortOption = sortBy.value;
                records.sort((a, b) => {
                    switch (sortOption) {
                        case 'lastUpdated':
                            const dateA = a.lastUpdated || a.addedDate;
                            const dateB = b.lastUpdated || b.addedDate;
                            return new Date(dateB) - new Date(dateA);
                        case 'lastUpdated-asc':
                            const dateC = a.lastUpdated || a.addedDate;
                            const dateC = a.lastUpdated || a.addedDate;
                            const dateD = b.lastUpdated || b.addedDate;
                            return new Date(dateC) - new Date(dateD);
                        case 'completionDate':
                            // 読了日がない場合は最も古い日付として扱う
                            const compDateA = a.completionDate || '0000-01-01';
                            const compDateB = b.completionDate || '0000-01-01';
                            return new Date(compDateB) - new Date(compDateA);
                        case 'completionDate-asc':
                            // 読了日がない場合は最も新しい日付として扱う
                            const compDateC = a.completionDate || '9999-12-31';
                            const compDateD = b.completionDate || '9999-12-31';
                            return new Date(compDateC) - new Date(compDateD);
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'title-desc':
                            return b.title.localeCompare(a.title);
                        case 'author':
                            return a.author.localeCompare(b.author);
                        case 'author-desc':
                            return b.author.localeCompare(a.author);
                        case 'publisher':
                            return a.publisher.localeCompare(b.publisher);
                        case 'publisher-desc':
                            return b.publisher.localeCompare(a.publisher);
                        case 'rating':
                            return (b.rating || 0) - (a.rating || 0);
                        case 'rating-asc':
                            return (a.rating || 0) - (b.rating || 0);
                        default:
                            return 0;
                    }
                });
                
                // リストをクリア
                bookListContainer.innerHTML = '';
                
                if (records.length === 0) {
                    bookListContainer.innerHTML = '<p>条件に一致する読書記録はありません</p>';
                    return;
                }
                
                // 表示モードに応じて表示
                const settings = getSettings();
                const viewMode = settings.viewMode || 'list';
                
                if (viewMode === 'grid') {
                    displayGridView(records);
                } else if (viewMode === 'series') {
                    displaySeriesView(records);
                } else {
                    // デフォルトはリスト表示
                    displayListView(records);
                }
            }
            
            // リスト表示
            function displayListView(records) {
                records.forEach(record => {
                    displayRecordItem(record);
                });
            }
            
            // グリッド表示
            function displayGridView(records) {
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid-view';
                
                records.forEach(record => {
                    const gridItem = createGridItem(record);
                    gridContainer.appendChild(gridItem);
                });
                
                bookListContainer.appendChild(gridContainer);
            }
            
            // グリッドアイテムを作成
            function createGridItem(record) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                
                const statusText = getStatusText(record.status);
                const statusClass = getStatusClass(record.status);
                
                // タイトルから巻数を抽出
                const { title, volumeNumber } = extractVolumeNumber(record.title);
                const displayTitle = volumeNumber ? 
                    `${title} (${volumeNumber})` : 
                    title;
                
                gridItem.innerHTML = `
                    <div class="grid-item-cover">
                        <img src="${record.coverSrc}" alt="${record.title}の書影" onerror="this.src='icons/placeholder.svg'">
                    </div>
                    <div class="grid-item-info">
                        <h3>${displayTitle}</h3>
                        <p>${record.author}</p>
                        <p class="book-list-status ${statusClass}">${statusText}</p>
                        ${record.rating ? createRatingStars(record.rating) : ''}
                    </div>
                `;
                
                // クリックイベントで詳細表示
                gridItem.addEventListener('click', () => {
                    showRecordDetails(record);
                });
                
                return gridItem;
            }
            
            // シリーズ表示
            function displaySeriesView(records) {
                // シリーズごとにグループ化
                const seriesGroups = groupBySeriesTitle(records);
                
                // 各シリーズを表示
                Object.entries(seriesGroups).forEach(([seriesTitle, books]) => {
                    const seriesGroup = document.createElement('div');
                    seriesGroup.className = 'series-group';
                    
                    // シリーズのステータスを判定
                    const isComplete = books.every(book => book.status === 'finished');
                    const statusClass = isComplete ? 'complete' : 'incomplete';
                    const statusText = isComplete ? '完読' : '未完';
                    
                    seriesGroup.innerHTML = `
                        <div class="series-header">
                            <h3 class="series-title">${seriesTitle}</h3>
                            <span class="series-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="series-books"></div>
                    `;
                    
                    const seriesBooks = seriesGroup.querySelector('.series-books');
                    
                    // 巻数でソート
                    books.sort((a, b) => {
                        const volA = extractVolumeNumber(a.title).volumeNumber || '0';
                        const volB = extractVolumeNumber(b.title).volumeNumber || '0';
                        return parseInt(volA) - parseInt(volB);
                    });
                    
                    // 各巻を表示
                    books.forEach(book => {
                        const bookItem = document.createElement('div');
                        bookItem.className = 'series-book-item';
                        
                        const { volumeNumber } = extractVolumeNumber(book.title);
                        const displayVolume = volumeNumber || '?';
                        
                        const statusClass = getStatusClass(book.status);
                        
                        bookItem.innerHTML = `
                            <div class="series-book-cover">
                                <img src="${book.coverSrc}" alt="${book.title}の書影" onerror="this.src='icons/placeholder.svg'">
                            </div>
                            <div class="series-book-info">
                                <h4>${displayVolume}</h4>
                                <p class="${statusClass}">${getStatusText(book.status)}</p>
                            </div>
                        `;
                        
                        // クリックイベントで詳細表示
                        bookItem.addEventListener('click', () => {
                            showRecordDetails(book);
                        });
                        
                        seriesBooks.appendChild(bookItem);
                    });
                    
                    bookListContainer.appendChild(seriesGroup);
                });
            }
            
            // シリーズタイトルでグループ化する関数
            function groupBySeriesTitle(records) {
                const groups = {};
                
                records.forEach(record => {
                    const { title } = extractVolumeNumber(record.title);
                    
                    // 巻数がある場合のみシリーズとして扱う
                    if (extractVolumeNumber(record.title).volumeNumber) {
                        if (!groups[title]) {
                            groups[title] = [];
                        }
                        groups[title].push(record);
                    }
                });
                
                // 1冊しかないシリーズは除外
                Object.keys(groups).forEach(title => {
                    if (groups[title].length <= 1) {
                        delete groups[title];
                    }
                });
                
                return groups;
            }
            
            // 読書記録アイテムを表示する関数
            function displayRecordItem(record) {
                const statusText = getStatusText(record.status);
                const statusClass = getStatusClass(record.status);
                
                // タイトルから巻数を抽出
                const { title, volumeNumber } = extractVolumeNumber(record.title);
                const displayTitle = volumeNumber ? 
                    `${title} (${volumeNumber})` : 
                    title;
                
                const recordElement = document.createElement('div');
                recordElement.className = 'book-list-item';
                
                // 星評価の表示を作成
                let ratingHtml = '';
                if (record.rating) {
                    ratingHtml = createRatingStars(record.rating);
                }
                
                // タグの表示を作成
                let tagsHtml = '';
                if (record.tags && record.tags.length > 0) {
                    tagsHtml = '<div class="book-list-tags">';
                    record.tags.forEach(tag => {
                        tagsHtml += `<span class="book-list-tag">${tag}</span>`;
                    });
                    tagsHtml += '</div>';
                }
                
                // 読了日の表示
                let completionDateHtml = '';
                if (record.status === 'finished' && record.completionDate) {
                    const formattedDate = formatDate(record.completionDate);
                    completionDateHtml = `<p>読了日: ${formattedDate}</p>`;
                }
                
                recordElement.innerHTML = `
                    <img class="book-list-cover" src="${record.coverSrc}" alt="${record.title}の書影" onerror="this.src='icons/placeholder.svg'">
                    <div class="book-list-info">
                        <h3 class="book-list-title">${displayTitle}</h3>
                        <p>${record.author}</p>
                        <span class="book-list-status ${statusClass}">${statusText}</span>
                        ${ratingHtml}
                        ${tagsHtml}
                        ${completionDateHtml}
                        <p class="book-list-date">追加日: ${formatDate(record.addedDate)}</p>
                    </div>
                `;
                
                // クリックイベントで詳細表示
                recordElement.addEventListener('click', () => {
                    showRecordDetails(record);
                });
                
                bookListContainer.appendChild(recordElement);
            }
            
            // 読書記録の詳細を表示する関数
            function showRecordDetails(record) {
                // 現在編集中の記録IDを設定
                currentRecordId = record.id;
                
                // 削除ボタンを表示
                deleteBookButton.style.display = 'block';
                
                // 書籍情報を表示
                displayBookInfo(record);
            }
            
            // 削除確認モーダルを表示する関数
            function showDeleteConfirmation() {
                deleteModal.style.display = 'flex';
            }
            
            // 読書記録を削除する関数
            function deleteRecord() {
                if (!currentRecordId) {
                    deleteModal.style.display = 'none';
                    return;
                }
                
                // 既存の読書記録を取得
                let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                // 削除対象の記録のインデックスを取得
                const index = records.findIndex(record => record.id === currentRecordId);
                
                if (index !== -1) {
                    // 記録を削除
                    records.splice(index, 1);
                    
                    // ローカルストレージに保存
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                    
                    // 読書記録を再表示
                    loadReadingRecords();
                    
                    // 書籍情報コンテナを非表示
                    bookContainer.style.display = 'none';
                    
                    // 編集モードをリセット
                    resetEditMode();
                    
                    // モーダルを閉じる
                    deleteModal.style.display = 'none';
                    
                    // 通知を表示
                    showNotification('読書記録を削除しました', 'success');
                } else {
                    // モーダルを閉じる
                    deleteModal.style.display = 'none';
                }
            }
            
            // 編集モードをリセットする関数
            function resetEditMode() {
                // 編集中の記録IDをリセット
                currentRecordId = null;
                
                // 削除ボタンを非表示
                deleteBookButton.style.display = 'none';
                
                // 戻るボタンを非表示
                backButton.style.display = 'none';
                
                // 入力欄をクリア
                readingNotes.value = '';
                
                // 読書状況を「未読」に設定
                readingStatusSelect.value = 'unread';
                
                // 読書状況ボタンを更新
                statusButtons.forEach(button => {
                    if (button.getAttribute('data-status') === 'unread') {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
                
                // 読了日コンテナを非表示
                completionDateContainer.classList.remove('show');
                completionDateInput.value = '';
                
                // 評価をリセット
                setRating(0);
                
                // タグをリセット
                currentTags = [];
                updateTagsDisplay();
            }
            
            // 表示モードを設定する関数
            function setViewMode(mode) {
                // 表示ボタンの状態を更新
                listViewButton.classList.remove('active');
                gridViewButton.classList.remove('active');
                seriesViewButton.classList.remove('active');
                
                switch(mode) {
                    case 'grid':
                        gridViewButton.classList.add('active');
                        break;
                    case 'series':
                        seriesViewButton.classList.add('active');
                        break;
                    default:
                        listViewButton.classList.add('active');
                        mode = 'list';
                        break;
                }
                
                // 設定を保存
                saveSettings('viewMode', mode);
                
                // 読書記録を再表示
                applyFiltersAndSort();
            }
            
            // テーマを切り替える関数
            function toggleTheme() {
                const hasTheme = document.body.hasAttribute('data-theme');
                
                if (hasTheme) {
                    const currentTheme = document.body.getAttribute('data-theme');
                    if (currentTheme === 'dark') {
                        document.body.setAttribute('data-theme', 'light');
                        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                        saveSettings('theme', 'light');
                    } else {
                        document.body.setAttribute('data-theme', 'dark');
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                        saveSettings('theme', 'dark');
                    }
                } else {
                    document.body.setAttribute('data-theme', 'dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    saveSettings('theme', 'dark');
                }
            }
            
            // 設定を読み込む関数
            function loadSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    // テーマを適用
                    if (settings.theme === 'dark') {
                        document.body.setAttribute('data-theme', 'dark');
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    } else if (settings.theme === 'light') {
                        document.body.setAttribute('data-theme', 'light');
                        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                    } else {
                        // テーマが設定されていない場合は、ユーザーのシステム設定に従う
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        if (prefersDark) {
                            document.body.setAttribute('data-theme', 'dark');
                            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                        }
                    }
                    
                    // 表示モードを適用
                    if (settings.viewMode) {
                        setViewMode(settings.viewMode);
                    }
                } else {
                    // 設定がない場合は、ユーザーのシステム設定に従う
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.setAttribute('data-theme', 'dark');
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
            }
            
            // 設定を取得する関数
            function getSettings() {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                return savedSettings ? JSON.parse(savedSettings) : {};
            }
            
            // 設定を保存する関数
            function saveSettings(key, value) {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                const settings = savedSettings ? JSON.parse(savedSettings) : {};
                
                settings[key] = value;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }
            
            // 全画面スキャナーの切り替え
            function toggleFullscreenScanner() {
                const isFullscreen = scannerContainer.classList.toggle('fullscreen-scanner');
                
                if (isFullscreen) {
                    document.body.style.overflow = 'hidden'; // スクロールを無効化
                    fullscreenButton.innerHTML = '<i class="fas fa-compress"></i> 通常表示';
                    
                    // 画面がロックされないようにする
                    if (navigator.wakeLock && isMobileDevice()) {
                        navigator.wakeLock.request('screen')
                            .then(wakeLock => {
                                // wakeLockを保存
                                scannerContainer.wakeLock = wakeLock;
                            })
                            .catch(err => {
                                console.log('画面ロック防止機能は利用できません:', err);
                            });
                    }
                    
                    // 画面の向きを横向きに固定（可能な場合）
                    if (screen.orientation && isMobileDevice()) {
                        screen.orientation.lock('landscape')
                            .catch(err => {
                                console.log('画面の向きを固定できませんでした:', err);
                            });
                    }
                    
                    // スキャンエリアのサイズを調整
                    adjustVideoSize();
                } else {
                    document.body.style.overflow = ''; // スクロールを有効化
                    fullscreenButton.innerHTML = '<i class="fas fa-expand"></i> 全画面';
                    
                    // wakeLockを解除
                    if (scannerContainer.wakeLock) {
                        scannerContainer.wakeLock.release();
                        scannerContainer.wakeLock = null;
                    }
                    
                    // 画面の向きの固定を解除
                    if (screen.orientation && isMobileDevice()) {
                        screen.orientation.unlock();
                    }
                }
            }
            
            // ビデオサイズを調整する関数
            function adjustVideoSize() {
                if (scannerVideo && scannerContainer.classList.contains('fullscreen-scanner')) {
                    // 画面の向きに応じてビデオのスタイルを調整
                    if (window.innerWidth > window.innerHeight) {
                        // 横向き
                        scannerVideo.style.width = '100%';
                        scannerVideo.style.height = 'auto';
                    } else {
                        // 縦向き
                        scannerVideo.style.height = '80%';
                        scannerVideo.style.width = 'auto';
                    }
                }
            }
            
            // スキャンタイムアウト機能
            function startScanTimeout() {
                // 30秒後にスキャンを停止
                clearTimeout(scanTimeoutId);
                scanTimeoutId = setTimeout(() => {
                    if (codeReader) {
                        showNotification('バーコードを検出できませんでした。手動で入力してください。', 'error');
                        manualOption.click();
                    }
                }, 30000);
            }

            function clearScanTimeout() {
                if (scanTimeoutId) {
                    clearTimeout(scanTimeoutId);
                    scanTimeoutId = null;
                }
            }
            
            // モバイルデバイスかどうかを判定する関数
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            // エラーメッセージを表示する関数
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // エラーメッセージを非表示にする関数
            function hideError() {
                errorMessage.style.display = 'none';
            }
            
            // 通知を表示する関数
            function showNotification(message, type = 'success') {
                // 既存の通知を削除
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notification => {
                    notification.remove();
                });
                
                // 通知を作成
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // 通知を追加
                document.body.appendChild(notification);
                
                // 自動的に削除（アニメーションが終わった後）
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            // 読書状況のテキストを取得する関数
            function getStatusText(status) {
                switch(status) {
                    case 'unread':
                        return '未読';
                    case 'reading':
                        return '読書中';
                    case 'finished':
                        return '読了';
                    default:
                        return '不明';
                }
            }
            
            // 読書状況のクラス名を取得する関数
            function getStatusClass(status) {
                switch(status) {
                    case 'unread':
                        return 'status-unread';
                    case 'reading':
                        return 'status-reading';
                    case 'finished':
                        return 'status-finished';
                    default:
                        return '';
                }
            }
            
            // 星評価のHTML文字列を作成する関数
            function createRatingStars(rating) {
                let html = '<div class="book-list-rating">';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) {
                        html += '<i class="fas fa-star active"></i>';
                    } else {
                        html += '<i class="fas fa-star"></i>';
                    }
                }
                html += '</div>';
                return html;
            }
            
            // 日付をフォーマットする関数
            function formatDate(dateStr) {
                if (!dateStr) return '';
                
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    return dateStr;
                }
                
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }
            
            // PWAのインストールプロンプト
            if (isMobileDevice()) {
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    // インストールプロンプトの表示を防止
                    e.preventDefault();
                    // プロンプトを保存
                    deferredPrompt = e;
                    
                    // インストール案内のバナーを表示
                    const installBanner = document.createElement('div');
                    installBanner.innerHTML = `
                        <div style="position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--primary-color); color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; z-index: 1000;">
                            <span>ホーム画面に追加して、オフラインで使用できます</span>
                            <button id="install-button" style="background-color: white; color: var(--primary-color); border: none; padding: 8px 16px; border-radius: 4px;">追加</button>
                            <button id="close-banner" style="background: none; border: none; color: white; font-size: 20px; margin-left: 10px;">&times;</button>
                        </div>
                    `;
                    document.body.appendChild(installBanner);
                    
                    // 追加ボタンのイベント
                    document.getElementById('install-button').addEventListener('click', () => {
                        // プロンプトを表示
                        deferredPrompt.prompt();
                        // ユーザーの選択を待つ
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('ユーザーがPWAのインストールを承認しました');
                            } else {
                                console.log('ユーザーがPWAのインストールを拒否しました');
                            }
                            deferredPrompt = null;
                            installBanner.remove();
                        });
                    });
                    
                    // 閉じるボタンのイベント
                    document.getElementById('close-banner').addEventListener('click', () => {
                        installBanner.remove();
                    });
                });
                
                // スマートフォン用のタッチイベント最適化
                document.addEventListener('touchstart', function(e) {
                    // iOSのダブルタップによるズームを防止（入力フィールドと選択フィールドは除く）
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // 開発用：モックAPIコントロールの表示/非表示
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                mockApiControls.style.display = 'block';
            } else {
                mockApiControls.style.display = 'none';
            }
        });
    </script>
</body>
</html>                    <input type="checkbox" id="use-mock-api" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span>モックAPIを使用（スタンドアロンモード）</span>
            </div>
            <div>
                <small>スタンドアロンモードでは、リモートサーバーを使わずにアプリを実行します。ISBNデータはローカルで生成されます。</small>
            </div>
        </div>

        <div class="search-container">
            <div class="search-options">
                <div id="manual-option" class="search-option active">手動入力</div>
                <div id="scan-option" class="search-option">バーコードスキャン</div>
            </div>
            
            <div id="manual-container">
                <div class="search-input-group">
                    <input type="text" id="isbn-input" placeholder="ISBNを入力（ハイフンなし13桁または10桁）">
                    <button id="search-button">検索</button>
                </div>
                <div id="error-message" class="error-message"></div>
            </div>
            
            <div id="scanner-container" style="display: none;">
                <video id="scanner-video"></video>
                <div class="camera-guide">
                    <div class="scan-area">
                        <div class="scan-line"></div>
                    </div>
                </div>
                <div class="camera-indicator"></div>
                <div class="scanner-message">バーコードをスキャンエリアに合わせてください</div>
                <div class="scanner-controls">
                    <button id="fullscreen-button"><i class="fas fa-expand"></i> 全画面</button>
                    <button id="scanner-switch-button"><i class="fas fa-sync"></i> カメラ切替</button>
                    <button id="scanner-stop-button"><i class="fas fa-times"></i> スキャン停止</button>
                </div>
            </div>
        </div>

        <div id="loading">
            <div class="loading-spinner"></div>
            <p>書籍情報を取得中...</p>
        </div>

        <div id="book-container" class="book-container">
            <div class="book-header">
                <img id="book-cover-img" class="book-cover" src="icons/placeholder.svg" alt="書影">
                <div class="book-info">
                    <h2 id="book-title" class="book-title">書籍タイトル</h2>
                    <p id="book-author" class="book-meta">著者: </p>
                    <p id="book-publisher" class="book-meta">出版社: </p>
                    <p id="book-published-date" class="book-meta">出版日: </p>
                    <p id="book-isbn" class="book-meta">ISBN: </p>
                </div>
            </div>

            <div class="reading-form">
                <div class="reading-form-group">
                    <div class="form-label">読書状況</div>
                    <div class="status-buttons">
                        <button type="button" class="status-button active" data-status="unread">未読</button>
                        <button type="button" class="status-button" data-status="reading">読書中</button>
                        <button type="button" class="status-button" data-status="finished">読了</button>
                    </div>
                    <select id="reading-status-select" style="display: none;">
                        <option value="unread">未読</option>
                        <option value="reading">読書中</option>
                        <option value="finished">読了</option>
                    </select>
                </div>

                <div id="completion-date" class="reading-form-group completion-date">
                    <label for="completion-date-input" class="form-label">読了日</label>
                    <input type="date" id="completion-date-input">
                </div>

                <div class="reading-form-group">
                    <label for="rating-stars" class="form-label">評価</label>
                    <div id="rating-stars" class="rating-stars">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                </div>

                <div class="reading-form-group">
                    <label for="tag-input" class="form-label">タグ</label>
                    <div id="tags-input-container" class="tags-input-container">
                        <input type="text" id="tag-input" placeholder="タグを追加">
                    </div>
                    <div id="tag-suggestions" class="tag-suggestions"></div>
                </div>

                <div class="reading-form-group">
                    <label for="reading-notes" class="form-label">メモ</label>
                    <textarea id="reading-notes"></textarea>
                </div>

                <div class="action-buttons">
                    <button id="delete-book-button" style="display: none;">削除</button>
                    <button id="add-book-button">保存</button>
                </div>
            </div>
        </div>

        <div class="filter-container">
            <div class="filter-row">
                <div class="filter-group">
                    <div class="filter-label">読書状況</div>
                    <select id="filter-status">
                        <option value="all">すべて</option>
                        <option value="unread">未読</option>
                        <option value="reading">読書中</option>
                        <option value="finished">読了</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label">評価</div>
                    <select id="filter-rating">
                        <option value="-1">すべて</option>
                        <option value="0">未評価</option>
                        <option value="1">★以上</option>
                        <option value="2">★★以上</option>
                        <option value="3">★★★以上</option>
                        <option value="4">★★★★以上</option>
                        <option value="5">★★★★★</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label">並び替え</div>
                    <select id="sort-by">
                        <option value="lastUpdated">更新日（新しい順）</option>
                        <option value="lastUpdated-asc">更新日（古い順）</option>
                        <option value="title">タイトル（昇順）</option>
                        <option value="title-desc">タイトル（降順）</option>
                        <option value="author">著者名（昇順）</option>
                        <option value="author-desc">著者名（降順）</option>
                        <option value="rating">評価（高い順）</option>
                        <option value="rating-asc">評価（低い順）</option>
                        <option value="completionDate">読了日（新しい順）</option>
                        <option value="completionDate-asc">読了日（古い順）</option>
                        <option value="publisher">出版社（昇順）</option>
                        <option value="publisher-desc">出版社（降順）</option>
                    </select>
                </div>
                
                <div class="view-options">
                    <button id="list-view-button" class="view-button active" title="リスト表示"><i class="fas fa-list"></i></button>
                    <button id="grid-view-button" class="view-button" title="グリッド表示"><i class="fas fa-th"></i></button>
                    <button id="series-view-button" class="view-button" title="シリーズ表示"><i class="fas fa-stream"></i></button>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-label">タグでフィルタリング:</div>
                <div id="filter-tags" class="filter-tags"></div>
            </div>
        </div>
        
        <div id="book-list-container" class="book-list-container"></div>
        
        <div id="add-button">
            <i class="fas fa-plus"></i>
        </div>
        
        <div id="delete-modal" class="delete-modal">
            <div class="modal-content">
                <h3 class="modal-title">削除の確認</h3>
                <p>この読書記録を削除してもよろしいですか？この操作は元に戻せません。</p>
                <div class="modal-actions">
                    <button id="cancel-delete">キャンセル</button>
                    <button id="confirm-delete">削除する</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // スタンドアロンモード対応のメインスクリプト
        document.addEventListener('DOMContentLoaded', function() {
            const isbnInput = document.getElementById('isbn-input');
            const searchButton = document.getElementById('search-button');
            const errorMessage = document.getElementById('error-message');
            const bookContainer = document.getElementById('book-container');
            const bookCoverImg = document.getElementById('book-cover-img');
            const bookTitle = document.getElementById('book-title');
            const bookAuthor = document.getElementById('book-author');
            const bookPublisher = document.getElementById('book-publisher');
            const bookPublishedDate = document.getElementById('book-published-date');
            const bookIsbn = document.getElementById('book-isbn');
            const readingStatusSelect = document.getElementById('reading-status-select');
            const readingNotes = document.getElementById('reading-notes');
            const addBookButton = document.getElementById('add-book-button');
            const deleteBookButton = document.getElementById('delete-book-button');
            const bookListContainer = document.getElementById('book-list-container');
            const manualOption = document.getElementById('manual-option');
            const scanOption = document.getElementById('scan-option');
            const manualContainer = document.getElementById('manual-container');
            const scannerContainer = document.getElementById('scanner-container');
            const scannerVideo = document.getElementById('scanner-video');
            const scannerSwitchButton = document.getElementById('scanner-switch-button');
            const scannerStopButton = document.getElementById('scanner-stop-button');
            const fullscreenButton = document.getElementById('fullscreen-button');
            const floatingButton = document.getElementById('add-button');
            const loadingElement = document.getElementById('loading');
            const offlineMessage = document.getElementById('offline-message');
            const ratingStars = document.getElementById('rating-stars');
            const tagInput = document.getElementById('tag-input');
            const tagsInputContainer = document.getElementById('tags-input-container');
            const tagSuggestions = document.getElementById('tag-suggestions');
            const filterStatus = document.getElementById('filter-status');
            const filterRating = document.getElementById('filter-rating');
            const sortBy = document.getElementById('sort-by');
            const filterTags = document.getElementById('filter-tags');
            const deleteModal = document.getElementById('delete-modal');
            const confirmDelete = document.getElementById('confirm-delete');
            const cancelDelete = document.getElementById('cancel-delete');
            const completionDateContainer = document.getElementById('completion-date');
            const completionDateInput = document.getElementById('completion-date-input');
            const statusButtons = document.querySelectorAll('.status-button');
            const themeToggle = document.getElementById('theme-toggle');
            const homeButton = document.getElementById('home-button');
            const backButton = document.getElementById('back-button');
            const listViewButton = document.getElementById('list-view-button');
            const gridViewButton = document.getElementById('grid-view-button');
            const seriesViewButton = document.getElementById('series-view-button');
            const useMockApiCheckbox = document.getElementById('use-mock-api');
            const mockApiControls = document.getElementById('mock-api-controls');

            // 読書記録を保存するローカルストレージのキー
            const STORAGE_KEY = 'reading_records';
            const TAGS_KEY = 'reading_tags';
            const SETTINGS_KEY = 'reading_settings';
            
            // 現在編集中の記録ID
            let currentRecordId = null;
            
            // 現在の評価（星）
            let currentRating = 0;
            
            // 現在のタグリスト
            let currentTags = [];
            
            // 全タグリスト
            let allTags = [];
            
            // アクティブなタグフィルター
            let activeTagFilters = [];
            
            // API呼び出しの再試行カウンター
            let apiRetryCount = 0;
            const MAX_API_RETRIES = 3;
            
            // スキャンタイムアウト
            let scanTimeoutId = null;
            
            // 設定を読み込む
            loadSettings();
            
            // オフライン状態の監視
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // URLパラメータを処理
            processUrlParams();
            
            // 初期表示時にオンライン状態を確認
            updateOnlineStatus();
            
            // オンライン状態を更新する関数
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    offlineMessage.style.display = 'none';
                } else {
                    offlineMessage.style.display = 'block';
                }
            }

            // 初期表示時に読書記録を読み込む
            loadReadingRecords();
            
            // 保存されたタグを読み込む
            loadTags();

            // バーコードスキャナー関連の変数
            let codeReader = null;
            let selectedDeviceId = null;
            let availableDevices = [];

            // 検索ボタンのクリックイベント
            searchButton.addEventListener('click', searchBook);

            // 追加ボタンのクリックイベント
            addBookButton.addEventListener('click', addBookToRecords);
            
            // 削除ボタンのクリックイベント
            deleteBookButton.addEventListener('click', showDeleteConfirmation);
            
            // 削除確認ボタンのイベント
            confirmDelete.addEventListener('click', deleteRecord);
            
            // 削除キャンセルボタンのイベント
            cancelDelete.addEventListener('click', () => {
                deleteModal.style.display = 'none';
            });

            // 検索オプションの切り替え
            manualOption.addEventListener('click', () => {
                manualOption.classList.add('active');
                scanOption.classList.remove('active');
                manualContainer.style.display = 'block';
                scannerContainer.style.display = 'none';
                if (codeReader) {
                    codeReader.reset();
                    clearScanTimeout();
                }
            });

            scanOption.addEventListener('click', () => {
                scanOption.classList.add('active');
                manualOption.classList.remove('active');
                manualContainer.style.display = 'none';
                scannerContainer.style.display = 'block';
                initScanner();
            });

            // カメラ切替ボタンのクリックイベント
            scannerSwitchButton.addEventListener('click', () => {
                if (codeReader && availableDevices.length > 1) {
                    // 現在のデバイスのインデックスを取得
                    const currentIndex = availableDevices.findIndex(device => device.deviceId === selectedDeviceId);
                    // 次のデバイスを選択
                    const nextIndex = (currentIndex + 1) % availableDevices.length;
                    selectedDeviceId = availableDevices[nextIndex].deviceId;
                    
                    // スキャナーを再起動
                    codeReader.reset();
                    clearScanTimeout();
                    startScanner(selectedDeviceId);
                }
            });

            // スキャン停止ボタンのクリックイベント
            scannerStopButton.addEventListener('click', () => {
                if (codeReader) {
                    codeReader.reset();
                    clearScanTimeout();
                    manualOption.click(); // 手動入力に切り替え
                }
            });
            
            // 全画面ボタンのクリックイベント
            if (fullscreenButton) {
                fullscreenButton.addEventListener('click', toggleFullscreenScanner);
            }

            // フローティングボタンのクリックイベント
            floatingButton.addEventListener('click', () => {
                // トップに戻ってISBN入力フォームにフォーカス
                window.scrollTo(0, 0);
                isbnInput.focus();
                
                // 編集モードをリセット
                resetEditMode();
            });

            // エンターキーでの検索
            isbnInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBook();
                }
            });
            
            // 星評価のクリックイベント
            ratingStars.addEventListener('click', function(e) {
                if (e.target.tagName === 'I') {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    setRating(rating);
                }
            });
            
            // 星評価のマウスオーバーイベント
            ratingStars.addEventListener('mouseover', function(e) {
                if (e.target.tagName === 'I') {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    highlightStars(rating);
                }
            });
            
            // 星評価のマウスアウトイベント
            ratingStars.addEventListener('mouseout', function() {
                highlightStars(currentRating);
            });
            
            // タグ入力のキーアップイベント
            tagInput.addEventListener('keyup', function(e) {
                const value = e.target.value.trim();
                
                if (e.key === 'Enter' && value) {
                    addTag(value);
                    e.target.value = '';
                    tagSuggestions.style.display = 'none';
                } else if (value) {
                    showTagSuggestions(value);
                } else {
                    tagSuggestions.style.display = 'none';
                }
            });
            
            // タグ入力のフォーカスイベント
            tagInput.addEventListener('focus', function() {
                if (this.value.trim()) {
                    showTagSuggestions(this.value.trim());
                }
            });
            
            // フィルターと並び替えのイベント
            filterStatus.addEventListener('change', applyFiltersAndSort);
            filterRating.addEventListener('change', applyFiltersAndSort);
            sortBy.addEventListener('change', applyFiltersAndSort);
            
            // 読書状況ボタンのイベント
            statusButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 現在のアクティブボタンを非アクティブに
                    statusButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // クリックされたボタンをアクティブに
                    this.classList.add('active');
                    
                    // セレクトボックスの値を更新
                    const status = this.getAttribute('data-status');
                    readingStatusSelect.value = status;
                    
                    // 読了の場合は読了日入力欄を表示
                    if (status === 'finished') {
                        completionDateContainer.classList.add('show');
                        // 読了日が未設定の場合は今日の日付をセット
                        if (!completionDateInput.value) {
                            const today = new Date().toISOString().split('T')[0];
                            completionDateInput.value = today;
                        }
                    } else {
                        completionDateContainer.classList.remove('show');
                    }
                });
            });
            
            // テーマ切り替えボタンのイベント
            themeToggle.addEventListener('click', toggleTheme);
            
            // ホームボタンのイベント
            homeButton.addEventListener('click', () => {
                // 書籍情報コンテナを非表示
                bookContainer.style.display = 'none';
                
                // 編集モードをリセット
                resetEditMode();
                
                // 読書記録一覧を表示
                loadReadingRecords();
            });
            
            // 戻るボタンのイベント
            backButton.addEventListener('click', () => {
                // 書籍情報コンテナを非表示
                bookContainer.style.display = 'none';
                
                // 編集モードをリセット
                resetEditMode();
            });
            
            // 表示切替ボタンのイベント
            listViewButton.addEventListener('click', () => {
                setViewMode('list');
            });
            
            gridViewButton.addEventListener('click', () => {
                setViewMode('grid');
            });
            
            seriesViewButton.addEventListener('click', () => {
                setViewMode('series');
            });
            
            // モックAPIの切り替えイベント
            useMockApiCheckbox.addEventListener('change', function() {
                localStorage.setItem('use_mock_api', this.checked ? 'true' : 'false');
                showNotification(this.checked ? 'スタンドアロンモードに切り替えました' : 'サーバーモードに切り替えました', 'success');
            });
            
            // URLパラメータを処理する関数
            function processUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('scan') && urlParams.get('scan') === 'true') {
                    // スキャンモードを自動的に開始
                    setTimeout(() => {
                        scanOption.click();
                    }, 500);
                }
                if (urlParams.has('add') && urlParams.get('add') === 'true') {
                    // ISBN入力フォームにフォーカス
                    setTimeout(() => {
                        isbnInput.focus();
                    }, 500);
                }
            }
            
            // 画面の向きの変更を検知
            window.addEventListener('orientationchange', function() {
                if (scannerContainer.classList.contains('fullscreen-scanner')) {
                    // スキャナーが全画面表示中なら、少し待ってからビデオサイズを調整
                    setTimeout(adjustVideoSize, 300);
                }
            });
            
            // モックAPIの設定を読み込む
            const savedUseMockApi = localStorage.getItem('use_mock_api');
            if (savedUseMockApi !== null) {
                useMockApiCheckbox.checked = savedUseMockApi === 'true';
            }
            
            // iOS Safariでのバウンス効果を防止
            document.addEventListener('touchmove', function(e) {
                if (scannerContainer.classList.contains('fullscreen-scanner')) {
                    e.preventDefault();
                }
            }, { passive: false });

            // バーコードスキャナーの初期化
            function initScanner() {
                if (!codeReader) {
                    try {
                        codeReader = new ZXing.BrowserMultiFormatReader();
                        
                        // カメラのアクセス許可を事前に確認
                        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                            .then(() => {
                                // 利用可能なビデオデバイスを取得
                                codeReader.listVideoInputDevices()
                                    .then((videoInputDevices) => {
                                        if (videoInputDevices.length === 0) {
                                            showError('カメラが見つかりませんでした');
                                            manualOption.click();
                                            return;
                                        }
                                        
                                        availableDevices = videoInputDevices;
                                        console.log('利用可能なカメラ:', availableDevices);
                                        
                                        // モバイルデバイスの場合は背面カメラを優先
                                        if (isMobileDevice()) {
                                            const backCamera = videoInputDevices.find(device => 
                                                device.label.toLowerCase().includes('back') || 
                                                device.label.toLowerCase().includes('後') ||
                                                device.label.toLowerCase().includes('背面') ||
                                                device.label.toLowerCase().includes('rear') ||
                                                device.label.toLowerCase().includes('環境') ||
                                                !device.label.toLowerCase().includes('front')
                                            );
                                            
                                            selectedDeviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;
                                            console.log('選択されたカメラID:', selectedDeviceId);
                                        } else {
                                            // デスクトップの場合は最初のカメラを使用
                                            selectedDeviceId = videoInputDevices[0].deviceId;
                                        }
                                        
                                        // カメラデバイスの切り替えボタンの表示/非表示を設定
                                        scannerSwitchButton.style.display = videoInputDevices.length > 1 ? 'block' : 'none';
                                        
                                        // スキャン開始
                                        startScanner(selectedDeviceId);
                                    })
                                    .catch((err) => {
                                        console.error('カメラデバイスの一覧取得エラー:', err);
                                        showError('カメラデバイスの一覧を取得できませんでした');
                                        manualOption.click();
                                    });
                            })
                            .catch((err) => {
                                console.error('カメラのアクセス許可エラー:', err);
                                showError('カメラへのアクセスが許可されていません。ブラウザの設定でカメラへのアクセスを許可してください。');
                                manualOption.click();
                            });
                    } catch (err) {
                        console.error('バーコードスキャナー初期化エラー:', err);
                        showError('バーコードスキャナーの初期化に失敗しました');
                        manualOption.click();
                    }
                } else {
                    try {
                        startScanner(selectedDeviceId);
                    } catch (err) {
                        console.error('スキャナー再起動エラー:', err);
                        showError('スキャナーの再起動に失敗しました');
                        manualOption.click();
                    }
                }
            }

            // スキャン開始
            function startScanner(deviceId) {
                try {
                    // デコード前にリセットして確実に新しいセッションを開始
                    if (codeReader) {
                        codeReader.reset();
                        clearScanTimeout();
                    }
                    
                    // ローディング表示
                    scannerVideo.style.filter = 'blur(3px)';
                    const loadingElement = document.createElement('div');
                    loadingElement.className = 'loading-spinner';
                    loadingElement.style.position = 'absolute';
                    loadingElement.style.top = '50%';
                    loadingElement.style.left = '50%';
                    loadingElement.style.transform = 'translate(-50%, -50%)';
                    scannerContainer.style.position = 'relative';
                    scannerContainer.appendChild(loadingElement);
                    
                    // フォーマット指定（ISBN-13のEAN-13フォーマットとISBN-10のコード39フォーマットを含む）
                    const hints = new Map();
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                        ZXing.BarcodeFormat.EAN_13,
                        ZXing.BarcodeFormat.CODE_39,
                        ZXing.BarcodeFormat.CODE_128
                    ]);
                    
                    // デコード開始
                    codeReader.decodeFromVideoDevice(deviceId, scannerVideo, (result, err) => {
                        // ローディング表示を削除
                        scannerVideo.style.filter = '';
                        const loadingSpinner = scannerContainer.querySelector('.loading-spinner');
                        if (loadingSpinner) {
                            loadingSpinner.remove();
                        }
                        
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error('デコードエラー:', err);
                            showError('バーコードの読み取り中にエラーが発生しました');
                            return;
                        }
                        
                        if (result) {
                            // ISBNが検出された場合
                            const rawIsbn = result.getText();
                            console.log('検出されたバーコード:', rawIsbn);
                            
                            // 検出したバーコードを強調表示
                            const canvas = document.createElement('canvas');
                            canvas.width = scannerVideo.videoWidth;
                            canvas.height = scannerVideo.videoHeight;
                            canvas.style.position = 'absolute';
                            canvas.style.top = '0';
                            canvas.style.left = '0';
                            scannerContainer.appendChild(canvas);
                            
                            const ctx = canvas.getContext('2d');
                            const resultPoints = result.getResultPoints();
                            
                            ctx.beginPath();
                            ctx.strokeStyle = 'red';
                            ctx.lineWidth = 5;
                            ctx.moveTo(resultPoints[0].getX(), resultPoints[0].getY());
                            for (let i = 1; i < result<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>読書記録アプリ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- ZXingライブラリを直接CDNから読み込む -->
    <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #03A9F4;
            --accent-color: #FF9800;
            --text-color: #333333;
            --background-color: #FFFFFF;
            --light-gray: #F5F5F5;
            --border-color: #E0E0E0;
            --error-color: #F44336;
            --success-color: #4CAF50;
            --unread-color: #9E9E9E;
            --reading-color: #2196F3;
            --finished-color: #4CAF50;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --star-inactive: #E0E0E0;
            --star-active: #FFC107;
        }

        [data-theme="dark"] {
            --primary-color: #1976D2;
            --secondary-color: #0288D1;
            --accent-color: #FFA726;
            --text-color: #F5F5F5;
            --background-color: #212121;
            --light-gray: #333333;
            --border-color: #424242;
            --unread-color: #9E9E9E;
            --reading-color: #2196F3;
            --finished-color: #4CAF50;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            --star-inactive: #555555;
            --star-active: #FFD700;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
            transition: var(--transition);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .search-container {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .search-options {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .search-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-right: 1rem;
        }

        .search-option.active {
            border-bottom: 3px solid var(--accent-color);
            font-weight: bold;
        }

        .search-input-group {
            display: flex;
            gap: 0.5rem;
        }

        input, select, textarea {
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background-color: var(--background-color);
            color: var(--text-color);
            flex-grow: 1;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .error-message {
            color: var(--error-color);
            margin-top: 0.5rem;
            display: none;
        }

        #loading {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .book-container {
            display: none;
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .book-header {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .book-cover {
            width: 140px;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: var(--shadow);
            background-color: var(--background-color);
        }

        .book-info {
            flex-grow: 1;
        }

        .book-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .book-meta {
            margin-bottom: 0.3rem;
        }

        .book-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        .book-link:hover {
            text-decoration: underline;
        }

        .reading-form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .status-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-button {
            background-color: var(--light-gray);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #reading-notes {
            min-height: 100px;
            width: 100%;
            resize: vertical;
        }

        .rating-stars {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }

        .rating-stars i {
            font-size: 1.5rem;
            color: var(--star-inactive);
            cursor: pointer;
            transition: var(--transition);
        }

        .rating-stars i.active, .book-list-rating i.active {
            color: var(--star-active);
        }

        .book-list-rating i {
            color: var(--star-inactive);
        }

        .tags-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-color);
            min-height: 45px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .remove-tag {
            margin-left: 0.3rem;
            cursor: pointer;
        }

        #tag-input {
            border: none;
            outline: none;
            background: transparent;
            padding: 0.3rem;
            flex-grow: 1;
            min-width: 100px;
        }

        .tag-suggestions {
            position: absolute;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            display: none;
            box-shadow: var(--shadow);
        }

        .tag-suggestion {
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .tag-suggestion:hover {
            background-color: var(--light-gray);
        }

        .completion-date {
            display: none;
        }

        .completion-date.show {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        #delete-book-button {
            background-color: var(--error-color);
        }

        #delete-book-button:hover {
            background-color: #D32F2F;
        }

        .filter-container {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex-grow: 1;
        }

        .filter-label {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .view-options {
            display: flex;
            gap: 0.5rem;
        }

        .view-button {
            background-color: var(--light-gray);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .filter-tag {
            display: inline-block;
            background-color: var(--light-gray);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .filter-tag.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .book-list-container {
            margin-top: 1.5rem;
        }

        .book-list-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .book-list-item:hover {
            background-color: var(--light-gray);
        }

        .book-list-cover {
            width: 70px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: var(--shadow);
            background-color: var(--background-color);
        }

        .book-list-info {
            flex-grow: 1;
        }

        .book-list-title {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .book-list-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }

        .status-unread {
            background-color: var(--unread-color);
            color: white;
        }

        .status-reading {
            background-color: var(--reading-color);
            color: white;
        }

        .status-finished {
            background-color: var(--finished-color);
            color: white;
        }

        .book-list-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }

        .book-list-tag {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .book-list-date {
            color: var(--unread-color);
            font-size: 0.9rem;
        }

        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1.5rem;
        }

        .grid-item {
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .grid-item-cover {
            height: 200px;
            overflow: hidden;
        }

        .grid-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .grid-item:hover .grid-item-cover img {
            transform: scale(1.05);
        }

        .grid-item-info {
            padding: 0.8rem;
            background-color: var(--light-gray);
        }

        .grid-item-info h3 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grid-item-info p {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .series-group {
            margin-bottom: 2rem;
            background-color: var(--light-gray);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
        }

        .series-title {
            margin: 0;
        }

        .series-status {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
        }

        .series-status.complete {
            background-color: var(--finished-color);
        }

        .series-status.incomplete {
            background-color: var(--reading-color);
        }

        .series-books {
            display: flex;
            overflow-x: auto;
            padding: 1rem;
            gap: 1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-gray);
        }

        .series-books::-webkit-scrollbar {
            height: 6px;
        }

        .series-books::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .series-books::-webkit-scrollbar-track {
            background-color: var(--light-gray);
        }

        .series-book-item {
            flex: 0 0 100px;
            cursor: pointer;
            transition: var(--transition);
        }

        .series-book-item:hover {
            transform: translateY(-5px);
        }

        .series-book-cover {
            height: 140px;
            width: 100px;
            margin-bottom: 0.5rem;
        }

        .series-book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        .series-book-info {
            text-align: center;
        }

        .series-book-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        #add-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: var(--transition);
            z-index: 90;
        }

        #add-button:hover {
            transform: scale(1.1);
            background-color: #FB8C00;
        }

        #offline-message {
            display: none;
            background-color: var(--error-color);
            color: white;
            padding: 0.5rem;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-color);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
        }

        .modal-title {
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #cancel-delete {
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        
        /* スキャナー関連のスタイル */
        #scanner-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .camera-guide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .scan-area {
            width: 70%;
            height: 20%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            position: relative;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: var(--accent-color);
            top: 0;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .scanner-message {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            font-size: 0.9rem;
        }
        
        .camera-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: red;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: fade-in-out 3s forwards;
            opacity: 0;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        /* フルスクリーンモード用のスタイル */
        .fullscreen-scanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: black;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .fullscreen-scanner #scanner-video {
            flex: 1;
            width: 100%;
            max-height: none;
            object-fit: contain;
        }
        
        .fullscreen-scanner .scanner-controls {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 1rem;
        }
        
        /* Mock API用のスタイル */
        #mock-api-controls {
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--light-gray);
            border-radius: 8px;
        }
        
        #mock-api-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 768px) {
            .book-header {
                flex-direction: column;
            }

            .book-cover {
                align-self: center;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .grid-view {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .search-input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .book-list-item {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 1rem 0.5rem;
            }
            
            .book-list-cover {
                margin-bottom: 1rem;
                width: 100px;
                height: 140px;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .view-options {
                margin-top: 0.5rem;
                align-self: flex-end;
            }
            
            .status-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #scanner-video {
                width: 100%;
                height: auto;
                max-height: 50vh;
                object-fit: cover;
            }
            
            .scanner-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .scanner-controls button {
                width: 100%;
            }
            
            #add-button {
                bottom: 1rem;
                right: 1rem;
            }
            
            /* iOS用のタップハイライトを無効化 */
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* 入力フィールドのズームを防止（iOS） */
            input, select, textarea {
                font-size: 16px;
            }
        }

        @media (prefers-color-scheme: dark) {
            body:not([data-theme="light"]) {
                --primary-color: #1976D2;
                --secondary-color: #0288D1;
                --accent-color: #FFA726;
                --text-color: #F5F5F5;
                --background-color: #212121;
                --light-gray: #333333;
                --border-color: #424242;
                --star-inactive: #555555;
                --star-active: #FFD700;
            }
        }
    </style>
</head>
<body>
    <div id="offline-message">オフラインモードです。一部の機能は利用できません。</div>

    <header>
        <button id="back-button" style="display: none;"><i class="fas fa-arrow-left"></i></button>
        <div class="header-title">読書記録アプリ</div>
        <div class="header-actions">
            <button id="home-button"><i class="fas fa-home"></i></button>
            <button id="theme-toggle"><i class="fas fa-moon"></i></button>
        </div>
    </header>

    <div class="container">
        <!-- スタンドアロンモード用のモックAPIコントロール（開発用） -->
        <div id="mock-api-controls">
            <div id="mock-api-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="use-mock-api" checked>
                    <span class="toggle-slider"></span>